(* see: https://jonasjacek.github.io/colors/ *)
let name_to_xterm_color = function
  | "BLACK" -> Some "0"
  | "RED" -> Some "1"
  | "GREEN" -> Some "2"
  | "YELLOW" -> Some "3"
  | "BLUE" -> Some "4"
  | "MAGENTA" -> Some "5"
  | "CYAN" -> Some "6"
  | "LIGHT-GRAY" -> Some "7"
  | "DARK-GRAY" -> Some "8"
  | "LIGHT-RED" -> Some "9"
  | "LIGHT-GREEN" -> Some "10"
  | "LIGHT-YELLOW" -> Some "11"
  | "LIGHT-BLUE" -> Some "12"
  | "LIGHT-MAGENTA" -> Some "13"
  | "LIGHT-CYAN" -> Some "14"
  | "WHITE" -> Some "15"
  | "GREY-0" -> Some "16"
  | "NAVY-BLUE" -> Some "17"
  | "DARK-BLUE" -> Some "18"
  | "BLUE-3A" -> Some "19"
  | "BLUE-3B" -> Some "20"
  | "BLUE-1" -> Some "21"
  | "DARK-GREEN" -> Some "22"
  | "DEEP-SKY-BLUE-4A" -> Some "23"
  | "DEEP-SKY-BLUE-4B" -> Some "24"
  | "DEEP-SKY-BLUE-4C" -> Some "25"
  | "DODGER-BLUE-3" -> Some "26"
  | "DODGER-BLUE-2" -> Some "27"
  | "GREEN-4" -> Some "28"
  | "SPRING-GREEN-4" -> Some "29"
  | "TURQUOISE-4" -> Some "30"
  | "DEEP-SKY-BLUE-3A" -> Some "31"
  | "DEEP-SKY-BLUE-3B" -> Some "32"
  | "DODGER-BLUE-1" -> Some "33"
  | "GREEN-3A" -> Some "34"
  | "SPRING-GREEN-3A" -> Some "35"
  | "DARK-CYAN" -> Some "36"
  | "LIGHT-SEA-GREEN" -> Some "37"
  | "DEEP-SKY-BLUE-2" -> Some "38"
  | "DEEP-SKY-BLUE-1" -> Some "39"
  | "GREEN-3B" -> Some "40"
  | "SPRING-GREEN-3B" -> Some "41"
  | "SPRING-GREEN-2A" -> Some "42"
  | "CYAN-3" -> Some "43"
  | "DARK-TURQUOISE" -> Some "44"
  | "TURQUOISE-2" -> Some "45"
  | "GREEN-1" -> Some "46"
  | "SPRING-GREEN-2B" -> Some "47"
  | "SPRING-GREEN-1" -> Some "48"
  | "MEDIUM-SPRING-GREEN" -> Some "49"
  | "CYAN-2" -> Some "50"
  | "CYAN-1" -> Some "51"
  | "DARK-RED-1" -> Some "52"
  | "DEEP-PINK-4A" -> Some "53"
  | "PURPLE-4A" -> Some "54"
  | "PURPLE-4B" -> Some "55"
  | "PURPLE-3" -> Some "56"
  | "BLUE-VIOLET" -> Some "57"
  | "ORANGE-4A" -> Some "58"
  | "GREY-37" -> Some "59"
  | "MEDIUM-PURPLE-4" -> Some "60"
  | "SLATE-BLUE-3A" -> Some "61"
  | "SLATE-BLUE-3B" -> Some "62"
  | "ROYAL-BLUE-1" -> Some "63"
  | "CHARTREUSE-4" -> Some "64"
  | "DARK-SEA-GREEN-4A" -> Some "65"
  | "PALE-TURQUOISE-4" -> Some "66"
  | "STEEL-BLUE" -> Some "67"
  | "STEEL-BLUE-3" -> Some "68"
  | "CORNFLOWER-BLUE" -> Some "69"
  | "CHARTREUSE-3A" -> Some "70"
  | "DARK-SEA-GREEN-4B" -> Some "71"
  | "CADET-BLUE-2" -> Some "72"
  | "CADET-BLUE-1" -> Some "73"
  | "SKY-BLUE-3" -> Some "74"
  | "STEEL-BLUE-1A" -> Some "75"
  | "CHARTREUSE-3B" -> Some "76"
  | "PALE-GREEN-3A" -> Some "77"
  | "SEA-GREEN-3" -> Some "78"
  | "AQUAMARINE-3" -> Some "79"
  | "MEDIUM-TURQUOISE" -> Some "80"
  | "STEEL-BLUE-1B" -> Some "81"
  | "CHARTREUSE-2A" -> Some "82"
  | "SEA-GREEN-2" -> Some "83"
  | "SEA-GREEN-1A" -> Some "84"
  | "SEA-GREEN-1B" -> Some "85"
  | "AQUAMARINE-1A" -> Some "86"
  | "DARK-SLATE-GRAY-2" -> Some "87"
  | "DARK-RED-2" -> Some "88"
  | "DEEP-PINK-4B" -> Some "89"
  | "DARK-MAGENTA-1" -> Some "90"
  | "DARK-MAGENTA-2" -> Some "91"
  | "DARK-VIOLET-1A" -> Some "92"
  | "PURPLE-1A" -> Some "93"
  | "ORANGE-4B" -> Some "94"
  | "LIGHT-PINK-4" -> Some "95"
  | "PLUM-4" -> Some "96"
  | "MEDIUM-PURPLE-3A" -> Some "97"
  | "MEDIUM-PURPLE-3B" -> Some "98"
  | "SLATE-BLUE-1" -> Some "99"
  | "YELLOW-4A" -> Some "100"
  | "WHEAT-4" -> Some "101"
  | "GREY-53" -> Some "102"
  | "LIGHT-SLATE-GREY" -> Some "103"
  | "MEDIUM-PURPLE" -> Some "104"
  | "LIGHT-SLATE-BLUE" -> Some "105"
  | "YELLOW-4B" -> Some "106"
  | "DARK-OLIVE-GREEN-3A" -> Some "107"
  | "DARK-GREEN-SEA" -> Some "108"
  | "LIGHT-SKY-BLUE-3A" -> Some "109"
  | "LIGHT-SKY-BLUE-3B" -> Some "110"
  | "SKY-BLUE-2" -> Some "111"
  | "CHARTREUSE-2B" -> Some "112"
  | "DARK-OLIVE-GREEN-3B" -> Some "113"
  | "PALE-GREEN-3B" -> Some "114"
  | "DARK-SEA-GREEN-3A" -> Some "115"
  | "DARK-SLATE-GRAY-3" -> Some "116"
  | "SKY-BLUE-1" -> Some "117"
  | "CHARTREUSE-1" -> Some "118"
  | "LIGHT-GREEN-2" -> Some "119"
  | "LIGHT-GREEN-3" -> Some "120"
  | "PALE-GREEN-1A" -> Some "121"
  | "AQUAMARINE-1B" -> Some "122"
  | "DARK-SLATE-GRAY-1" -> Some "123"
  | "RED-3A" -> Some "124"
  | "DEEP-PINK-4C" -> Some "125"
  | "MEDIUM-VIOLET-RED" -> Some "126"
  | "MAGENTA-3A" -> Some "127"
  | "DARK-VIOLET-1B" -> Some "128"
  | "PURPLE-1B" -> Some "129"
  | "DARK-ORANGE-3A" -> Some "130"
  | "INDIAN-RED-1A" -> Some "131"
  | "HOT-PINK-3A" -> Some "132"
  | "MEDIUM-ORCHID-3" -> Some "133"
  | "MEDIUM-ORCHID" -> Some "134"
  | "MEDIUM-PURPLE-2A" -> Some "135"
  | "DARK-GOLDENROD" -> Some "136"
  | "LIGHT-SALMON-3A" -> Some "137"
  | "ROSY-BROWN" -> Some "138"
  | "GREY-63" -> Some "139"
  | "MEDIUM-PURPLE-2B" -> Some "140"
  | "MEDIUM-PURPLE-1" -> Some "141"
  | "GOLD-3A" -> Some "142"
  | "DARK-KHAKI" -> Some "143"
  | "NAVAJO-WHITE-3" -> Some "144"
  | "GREY-69" -> Some "145"
  | "LIGHT-STEEL-BLUE-3" -> Some "146"
  | "LIGHT-STEEL-BLUE" -> Some "147"
  | "YELLOW-3A" -> Some "148"
  | "DARK-OLIVE-GREEN-3" -> Some "149"
  | "DARK-SEA-GREEN-3B" -> Some "150"
  | "DARK-SEA-GREEN-2" -> Some "151"
  | "LIGHT-CYAN-3" -> Some "152"
  | "LIGHT-SKY-BLUE-1" -> Some "153"
  | "GREEN-YELLOW" -> Some "154"
  | "DARK-OLIVE-GREEN-2" -> Some "155"
  | "PALE-GREEN-1B" -> Some "156"
  | "DARK-SEA-GREEN-5B" -> Some "157"
  | "DARK-SEA-GREEN-5A" -> Some "158"
  | "PALE-TURQUOISE-1" -> Some "159"
  | "RED-3B" -> Some "160"
  | "DEEP-PINK-3A" -> Some "161"
  | "DEEP-PINK-3B" -> Some "162"
  | "MAGENTA-3B" -> Some "163"
  | "MAGENTA-3C" -> Some "164"
  | "MAGENTA-2A" -> Some "165"
  | "DARK-ORANGE-3B" -> Some "166"
  | "INDIAN-RED-1B" -> Some "167"
  | "HOT-PINK-3B" -> Some "168"
  | "HOT-PINK-2" -> Some "169"
  | "ORCHID" -> Some "170"
  | "MEDIUM-ORCHID-1A" -> Some "171"
  | "ORANGE-3" -> Some "172"
  | "LIGHT-SALMON-3B" -> Some "173"
  | "LIGHT-PINK-3" -> Some "174"
  | "PINK-3" -> Some "175"
  | "PLUM-3" -> Some "176"
  | "VIOLET" -> Some "177"
  | "GOLD-3B" -> Some "178"
  | "LIGHT-GOLDENROD-3" -> Some "179"
  | "TAN" -> Some "180"
  | "MISTY-ROSE-3" -> Some "181"
  | "THISTLE-3" -> Some "182"
  | "PLUM-2" -> Some "183"
  | "YELLOW-3B" -> Some "184"
  | "KHAKI-3" -> Some "185"
  | "LIGHT-GOLDENROD-2A" -> Some "186"
  | "LIGHT-YELLOW-3" -> Some "187"
  | "GREY-84" -> Some "188"
  | "LIGHT-STEEL-BLUE-1" -> Some "189"
  | "YELLOW-2" -> Some "190"
  | "DARK-OLIVE-GREEN-1A" -> Some "191"
  | "DARK-OLIVE-GREEN-1B" -> Some "192"
  | "DARK-SEA-GREEN-1" -> Some "193"
  | "HONEYDEW-2" -> Some "194"
  | "LIGHT-CYAN-1" -> Some "195"
  | "RED-1" -> Some "196"
  | "DEEP-PINK-2" -> Some "197"
  | "DEEP-PINK-1A" -> Some "198"
  | "DEEP-PINK-1B" -> Some "199"
  | "MAGENTA-2B" -> Some "200"
  | "MAGENTA-1" -> Some "201"
  | "ORANGE-RED-1" -> Some "202"
  | "INDIAN-RED-1C" -> Some "203"
  | "INDIAN-RED-1D" -> Some "204"
  | "HOT-PINK-1A" -> Some "205"
  | "HOT-PINK-1B" -> Some "206"
  | "MEDIUM-ORCHID-1B" -> Some "207"
  | "DARK-ORANGE" -> Some "208"
  | "SALMON-1" -> Some "209"
  | "LIGHT-CORAL" -> Some "210"
  | "PALE-VIOLET-RED-1" -> Some "211"
  | "ORCHID-2" -> Some "212"
  | "ORCHID-1" -> Some "213"
  | "ORANGE-1" -> Some "214"
  | "SANDY-BROWN" -> Some "215"
  | "LIGHT-SALMON-1" -> Some "216"
  | "LIGHT-PINK-1" -> Some "217"
  | "PINK-1" -> Some "218"
  | "PLUM-1" -> Some "219"
  | "GOLD-1" -> Some "220"
  | "LIGHT-GOLDENROD-2B" -> Some "221"
  | "LIGHT-GOLDENROD-2C" -> Some "222"
  | "NAVAJO-WHITE-1" -> Some "223"
  | "MISTY-ROSE1" -> Some "224"
  | "THISTLE-1" -> Some "225"
  | "YELLOW-1" -> Some "226"
  | "LIGHT-GOLDENROD-1" -> Some "227"
  | "KHAKI-1" -> Some "228"
  | "WHEAT-1" -> Some "229"
  | "CORNSILK-1" -> Some "230"
  | "GREY-100" -> Some "231"
  | "GREY-3" -> Some "232"
  | "GREY-7" -> Some "233"
  | "GREY-11" -> Some "234"
  | "GREY-15" -> Some "235"
  | "GREY-19" -> Some "236"
  | "GREY-23" -> Some "237"
  | "GREY-27" -> Some "238"
  | "GREY-30" -> Some "239"
  | "GREY-35" -> Some "240"
  | "GREY-39" -> Some "241"
  | "GREY-42" -> Some "242"
  | "GREY-46" -> Some "243"
  | "GREY-50" -> Some "244"
  | "GREY-54" -> Some "245"
  | "GREY-58" -> Some "246"
  | "GREY-62" -> Some "247"
  | "GREY-66" -> Some "248"
  | "GREY-70" -> Some "249"
  | "GREY-74" -> Some "250"
  | "GREY-78" -> Some "251"
  | "GREY-82" -> Some "252"
  | "GREY-85" -> Some "253"
  | "GREY-89" -> Some "254"
  | "GREY-93" -> Some "255"
  | _ -> None

let fg_color code = "38;5;" ^ code

let bg_color code = "48;5;" ^ code

let str_to_esc_seq = function
  | "bold" -> Some "1"
  | "dim" -> Some "2"
  | "italic" -> Some "3"
  | "underline" -> Some "4"
  | "blink" -> Some "5"
  | "rapid-blink" -> Some "5"
  | "inverse" -> Some "7"
  | "hidden" -> Some "8"
  | "strikethru" -> Some "9"
  | "#f09933" -> Some "38;2;240;153;51"
  | s -> match name_to_xterm_color @@ String.uppercase_ascii s with
    | Some code -> Some (fg_color code)
    | None -> None

let stack_to_esc stack =
  "\027["
  ^ (String.concat ";" @@ List.rev @@ List.of_seq @@ Stack.to_seq stack)
  ^ "m"

let pp_colorized ppf fmt =
  let stack = Stack.of_seq @@ Seq.return "0" in
  let color_tag_funs : Format.formatter_stag_functions =
    {
      mark_open_stag = (fun stag ->
        match stag with
        | Format.String_tag s -> (match str_to_esc_seq @@ String.lowercase_ascii s with
          | None -> ""
          | Some eseq -> begin
            Stack.push eseq stack;
            stack_to_esc stack
          end)
        | _ -> "");
      mark_close_stag = (fun _ ->
        ignore @@ Stack.pop stack;
        stack_to_esc stack);
      print_open_stag = (fun _ -> ());
      print_close_stag = (fun _ -> ());
    }
  in
  Format.pp_set_formatter_stag_functions ppf color_tag_funs;
  let mark_tags = Format.pp_get_mark_tags ppf () in
  Format.pp_set_mark_tags ppf true;
  Format.kfprintf (fun ppf -> Format.pp_set_mark_tags ppf mark_tags)
  ppf fmt

let () =
  Format.printf "...\n";
  pp_colorized
    Format.std_formatter
    "@{<light-steel-blue>@{<bold>Hello @{<underline>there@} you@} again @{<strikethru>mate@}@} @{<red>warning@}\n";
  Format.printf "...\n";
